name: Publish Python
on:
  workflow_dispatch:
    inputs:
      mode:
        description: "release | test | beta | alpha"
        required: false
        default: "release"
      force_release:
        description: "force alpha/beta publish"
        required: false
        default: "false"
  push:
    branches:
      - main

jobs:
  build:
    if: ${{ (github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '--release') || contains(github.event.head_commit.message, '--test') || contains(github.event.head_commit.message, '--beta') || contains(github.event.head_commit.message, '--alpha') || contains(toJson(github.event.commits), '--release') || contains(toJson(github.event.commits), '--test') || contains(toJson(github.event.commits), '--beta') || contains(toJson(github.event.commits), '--alpha')) && !contains(github.event.head_commit.message, '--na') && !contains(toJson(github.event.commits), '--na') }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Resolve Mode
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "RELEASE_MODE=${{ inputs.mode }}" >> $GITHUB_ENV
            echo "FORCE_RELEASE=${{ inputs.force_release }}" >> $GITHUB_ENV
          else
            msg="${{ github.event.head_commit.message }}"
            if echo "$msg" | grep -q -- "--test"; then
              echo "RELEASE_MODE=test" >> $GITHUB_ENV
            elif echo "$msg" | grep -q -- "--beta"; then
              echo "RELEASE_MODE=beta" >> $GITHUB_ENV
            elif echo "$msg" | grep -q -- "--alpha"; then
              echo "RELEASE_MODE=alpha" >> $GITHUB_ENV
            else
              echo "RELEASE_MODE=release" >> $GITHUB_ENV
            fi
            if echo "$msg" | grep -q -- "--force_release"; then
              echo "FORCE_RELEASE=true" >> $GITHUB_ENV
            else
              echo "FORCE_RELEASE=false" >> $GITHUB_ENV
            fi
          fi
      - name: Resolve Release Meta
        run: python libs/python/tools/release_meta.py --mode "${{ env.RELEASE_MODE }}" --force "${{ env.FORCE_RELEASE }}" >> $GITHUB_ENV
      - name: Set Version
        run: python libs/python/tools/version.py --set "${{ env.PY_VERSION }}"
      - name: Install Build Tools
        run: python -m pip install --upgrade pip build
      - name: Build Wheels
        uses: pypa/cibuildwheel@v2.16.2
        env:
          CIBW_PACKAGE_DIR: libs/python
          CIBW_OUTPUT_DIR: libs/python/dist
          CIBW_BUILD: "cp38-* cp39-* cp310-* cp311-* cp312-*"
      - name: Build Sdist
        run: python -m build --sdist --outdir libs/python/dist libs/python
      - name: Upload Wheels
        uses: actions/upload-artifact@v4
        with:
          name: python-dist-${{ matrix.os }}
          path: libs/python/dist
          if-no-files-found: error

  publish:
    if: ${{ (github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '--release') || contains(github.event.head_commit.message, '--test') || contains(github.event.head_commit.message, '--beta') || contains(github.event.head_commit.message, '--alpha') || contains(toJson(github.event.commits), '--release') || contains(toJson(github.event.commits), '--test') || contains(toJson(github.event.commits), '--beta') || contains(toJson(github.event.commits), '--alpha')) && needs.build.result == 'success' && !contains(github.event.head_commit.message, '--na') && !contains(toJson(github.event.commits), '--na') }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Resolve Mode
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "RELEASE_MODE=${{ inputs.mode }}" >> $GITHUB_ENV
            echo "FORCE_RELEASE=${{ inputs.force_release }}" >> $GITHUB_ENV
          else
            msg="${{ github.event.head_commit.message }}"
            if echo "$msg" | grep -q -- "--test"; then
              echo "RELEASE_MODE=test" >> $GITHUB_ENV
            elif echo "$msg" | grep -q -- "--beta"; then
              echo "RELEASE_MODE=beta" >> $GITHUB_ENV
            elif echo "$msg" | grep -q -- "--alpha"; then
              echo "RELEASE_MODE=alpha" >> $GITHUB_ENV
            else
              echo "RELEASE_MODE=release" >> $GITHUB_ENV
            fi
            if echo "$msg" | grep -q -- "--force_release"; then
              echo "FORCE_RELEASE=true" >> $GITHUB_ENV
            else
              echo "FORCE_RELEASE=false" >> $GITHUB_ENV
            fi
          fi
      - name: Resolve Release Meta
        run: python libs/python/tools/release_meta.py --mode "${{ env.RELEASE_MODE }}" --force "${{ env.FORCE_RELEASE }}" >> $GITHUB_ENV
      - name: Set Tag Name
        run: |
          if [ "${{ env.RELEASE_MODE }}" = "test" ]; then
            echo "TAG_NAME=py-test-v${{ env.PY_VERSION }}" >> $GITHUB_ENV
          elif [ "${{ env.RELEASE_MODE }}" = "beta" ]; then
            echo "TAG_NAME=py-beta-v${{ env.PY_VERSION }}" >> $GITHUB_ENV
          elif [ "${{ env.RELEASE_MODE }}" = "alpha" ]; then
            echo "TAG_NAME=py-alpha-v${{ env.PY_VERSION }}" >> $GITHUB_ENV
          else
            echo "TAG_NAME=py-v${{ env.PY_VERSION }}" >> $GITHUB_ENV
          fi
      - name: Set Version
        run: |
          python libs/python/tools/version.py --set "${{ env.PY_VERSION }}"
      - name: Download Wheels
        uses: actions/download-artifact@v4
        with:
          path: libs/python/dist
          merge-multiple: true
      - name: Tag Release
        if: ${{ env.SKIP_PUBLISH != 'true' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if git rev-parse "${{ env.TAG_NAME }}" >/dev/null 2>&1; then
            echo "SKIP_PUBLISH=true" >> $GITHUB_ENV
            exit 0
          fi
          git tag "${{ env.TAG_NAME }}"
          git push origin "${{ env.TAG_NAME }}"
      - name: GitHub Release
        if: ${{ env.SKIP_PUBLISH != 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: nextssl py ${{ env.PY_VERSION }}
          body_path: ${{ env.NOTE_PATH }}
          prerelease: ${{ env.PRERELEASE }}
      - name: Publish to PyPI
        if: ${{ env.SKIP_PUBLISH != 'true' && env.RELEASE_MODE != 'test' }}
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: libs/python/dist
          password: ${{ secrets.PYPI_API_TOKEN }}
      - name: Publish to TestPyPI
        if: ${{ env.SKIP_PUBLISH != 'true' && env.RELEASE_MODE == 'test' }}
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: libs/python/dist
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
          repository-url: https://test.pypi.org/legacy/
